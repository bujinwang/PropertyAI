# Story 19.1: Stripe Integration and Payment Setup

## Status: Draft

## Story

As a property owner,
I want to integrate Stripe for secure payment processing,
so that tenants can safely save payment methods and I can process rent payments securely.

## Acceptance Criteria

1. Stripe SDK integrated with proper API key configuration
2. Tenant model extended with payment method storage (Stripe customer ID, payment method IDs)
3. POST /api/payments/setup-customer endpoint creates Stripe customer and returns client secret
4. POST /api/payments/setup-payment-method endpoint saves payment method for tenant
5. GET /api/payments/payment-methods endpoint retrieves saved payment methods for tenant
6. DELETE /api/payments/payment-methods/:id endpoint removes payment method
7. Role-based access: tenants can only manage their own payment methods, owners/managers can view all
8. PCI DSS compliance maintained through Stripe's hosted fields
9. Error handling for Stripe API failures with appropriate user messages
10. No sensitive payment data stored in application database

## Dev Notes

**Previous Story Insights:** N/A (first story in Epic 19).

**Data Models:** Extend Tenant model with stripeCustomerId (string), add PaymentMethod model with tenantId, stripePaymentMethodId, type (card/ach), last4, brand, isDefault [Source: architecture/data-models.md].

**API Specifications:** All endpoints require JWT auth, return standardized response format with success/error fields; use Stripe webhooks for async updates [Source: architecture/rest-api-spec.md].

**Component Specifications:** Add PaymentSetup component with Stripe Elements for secure form collection; PaymentMethodsList for managing saved methods [Source: architecture/components.md].

**File Locations:** New: src/services/stripeService.js, src/routes/payments.js; Extend: src/models/Tenant.js, src/models/PaymentMethod.js; Frontend: dashboard/src/components/PaymentSetup.tsx, dashboard/src/services/paymentService.ts.

**Testing Requirements:** Unit tests for service functions with mocked Stripe API, integration tests for endpoints, RTL for components with mocked Stripe Elements [Source: testing-strategy.md].

**Technical Constraints:** Use Stripe Node.js SDK v12+, implement webhook signature verification, handle rate limiting, comply with Stripe's terms of service.

## Tasks / Subtasks

- [ ] Task 1: Set up Stripe SDK and configuration
  - [ ] Install stripe npm package
  - [ ] Add Stripe API keys to environment configuration
  - [ ] Create stripeService.js with initialization and basic functions

- [ ] Task 2: Extend database models for payment data
  - [ ] Add stripeCustomerId field to Tenant model
  - [ ] Create PaymentMethod model with required fields
  - [ ] Create database migration for schema changes

- [ ] Task 3: Implement customer management endpoints
  - [ ] POST /api/payments/setup-customer - create Stripe customer
  - [ ] GET /api/payments/customer - retrieve customer info
  - [ ] Error handling for Stripe API failures

- [ ] Task 4: Implement payment method management
  - [ ] POST /api/payments/setup-payment-method - save payment method
  - [ ] GET /api/payments/payment-methods - list saved methods
  - [ ] DELETE /api/payments/payment-methods/:id - remove payment method

- [ ] Task 5: Frontend payment setup component
  - [ ] Create PaymentSetup component with Stripe Elements
  - [ ] Implement secure payment method collection
  - [ ] Add form validation and error handling

- [ ] Task 6: Frontend payment methods management
  - [ ] Create PaymentMethodsList component
  - [ ] Implement add/remove payment methods functionality
  - [ ] Add loading states and error handling

- [ ] Task 7: Security and compliance verification
  - [ ] Verify no sensitive data stored locally
  - [ ] Test role-based access controls
  - [ ] Validate PCI DSS compliance approach

## Dev Agent Record

**Agent Model Used:** openrouter/sonoma-sky-alpha

**Debug Log References:** N/A

**Completion Notes List:**
- Stripe integration follows PCI DSS compliance best practices
- All payment data handled through Stripe's secure infrastructure
- Webhook endpoints prepared for future payment status updates

**File List:**
- src/services/stripeService.js (new)
- src/routes/payments.js (new)
- src/models/PaymentMethod.js (new)
- src/models/migrations/20250914-add-payment-fields.js (new)
- dashboard/src/components/PaymentSetup.tsx (new)
- dashboard/src/components/PaymentMethodsList.tsx (new)
- dashboard/src/services/paymentService.ts (new)

**Change Log:**
- 2025-09-14: Initial draft for Stripe integration setup.