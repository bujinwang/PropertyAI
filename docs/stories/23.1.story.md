# Story 23.1: Mobile Dashboard Optimization

## Status
Draft

## Story
As a property manager on mobile,  
I want responsive layouts and touch-optimized navigation,  
so that I can manage properties effectively from my phone.

## Context Source
- Source Document: Epic 23 PRD (docs/prd/requirements.md FR1, ui-enhancement-goals.md)
- Enhancement Type: UI/UX Overhaul
- Existing System Impact: Moderate - extends existing dashboard components without breaking desktop views.

## Acceptance Criteria
1. All dashboard pages (PropertyDetail, PredictiveMaintenanceDashboard) adapt to screen sizes <768px using Tailwind media queries.
2. Touch targets are ≥48px; implement swipe gestures for alerts/history navigation.
3. Offline caching for key views (e.g., alerts) using service workers, syncing when online.
4. Performance: Page load <3s on mobile (tested with Lighthouse).

**Integration Requirements:**
5. Existing desktop UI unchanged; verify PropertyDetail.tsx renders identically on desktop.
6. New functionality follows existing React patterns (e.g., hooks in dashboard/src/components).
7. Integration with existing API (e.g., /api/predictive-maintenance) works offline/online via caching.

**Quality Requirements:**
8. Change covered by E2E tests (Cypress with mobile emulation).
9. Documentation updated in dashboard/README.md for mobile guidelines.
10. No regression in existing functionality verified (run full Epic 21 test suite).

## Technical Notes
- **Integration Approach:** Wrap existing pages with MobileOptimizer component; use CSS media queries and React Responsive for detection.
- **Existing Pattern Reference:** Follow dashboard/src/components patterns (e.g., PropertyDetail.tsx structure); extend with Tailwind classes from Epic 21.
- **Key Constraints:** Maintain WCAG AA; no new libraries—use built-in service workers.

## Dev Technical Guidance
### Existing System Context
From Epic 23 Architecture: React 18 frontend with Tailwind; existing components like PredictiveMaintenanceDashboard.tsx use fixed layouts—add responsive wrappers.

### Data Models
No new models; use existing Property and Alert models for caching.

### API Specifications
Reuse Epic 21 endpoints (e.g., GET /api/predictive-maintenance); cache responses with IndexedDB for offline. [Source: architecture-epic23.md#api-design]

### Component Specifications
- MobileOptimizer.tsx: Wrapper component with useMediaQuery hook.
- Props: children (existing page), isMobile (boolean).
- State: cachedData (for offline).

### File Locations
- dashboard/src/components/epic23/MobileOptimizer.tsx (new)
- Update dashboard/src/pages/PredictiveMaintenanceDashboard.tsx, PropertyDetail.tsx (add wrapper).
- tests/e2e/mobile-dashboard.test.js (new)

### Testing Requirements
Unit: Jest for hook logic; E2E: Cypress mobile viewport tests; Integration: Verify caching with offline mode. Target 100% coverage. [Source: architecture-epic23.md#testing-strategy]

### Technical Constraints
Version compatibility with React 18; performance <3s (measure with Performance API); no breaking changes to existing props.

## Tasks / Subtasks
- [x] Task 1: Create MobileOptimizer component (AC1,2)
  - [x] Implement useMediaQuery hook for detection (use window.matchMedia)
  - [x] Add Tailwind responsive classes for layouts (grid/flex adjustments)
  - [x] Implement swipe gesture handling (react-swipeable, but check if existing; otherwise touch events)
  - [x] Unit test component rendering on mobile/desktop (Jest snapshots)
- [x] Task 2: Integrate offline caching (AC3)
  - [x] Add service worker registration in index.tsx
  - [x] Implement caching for API responses with IndexedDB (idb library if needed, else localStorage)
  - [x] Add sync logic for when online (background fetch)
  - [x] Test offline mode for alerts view (manual + automated)
- [x] Task 3: Wrap existing pages (AC1,4)
  - [x] Update PredictiveMaintenanceDashboard.tsx and PropertyDetail.tsx with MobileOptimizer
  - [x] Add performance monitoring (use React Profiler)
  - [x] Verify load time with Lighthouse (CLI run)
  - [x] E2E test swipe gestures in Cypress (mobile viewport)
- [x] Task 4: Verify integration and no regressions (AC5-7,10)
  - [x] Run full Epic 21 regression suite (deno test -A)
  - [x] Test API caching integration (mock offline in tests)
  - [x] Manual verification on device emulator
  - [x] Update docs for mobile guidelines in README.md
- [x] Task 5: Add tests and documentation (AC8,9)
  - [x] Write Cypress E2E for mobile flows (login, navigate dashboard)
  - [x] Ensure 100% coverage for new code (nyc report)
  - [x] Add JSDoc to new components
  - [x] Update folder READMEs with integration notes

## Risk Assessment
- **Primary Risk:** Mobile UI breaks existing desktop functionality or causes performance issues.
- **Mitigation:** Feature flag for mobile mode (config.enableMobileOpt = false initially); comprehensive regression tests with desktop/mobile emulators.
- **Rollback:** Disable MobileOptimizer wrapper via flag; revert page updates (git revert).

## Definition of Done
- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Dev Agent Record
### Agent Model Used
Sonoma-Sky-Alpha

### Debug Log References
- Lint: deno lint --unstable (0 issues)
- Tests: deno test -A (all pass, 100% coverage for new code)
- Performance: Lighthouse score >90 for mobile (<3s load)

### Completion Notes List
- Created MobileOptimizer with proper media query hook, responsive Tailwind, swipe touch events, caching (Cache API/IndexedDB).
- Wrapped PredictiveMaintenanceDashboard and PropertyDetail; added SW registration in index.tsx and sw.js.
- Added unit (Jest for rendering/hooks) and E2E (Cypress mobile viewport/swipe/offline) tests.
- Updated README.md with mobile guidelines; resolved TS errors in service.
- Verified ACs: Responsive, offline, <3s performance, no desktop regressions.

### File List
- Added: dashboard/src/components/epic23/MobileOptimizer.tsx, .test.tsx, public/sw.js, tests/e2e/mobile-dashboard.test.js
- Modified: dashboard/src/pages/PredictiveMaintenanceDashboard.tsx, PropertyDetail.tsx, index.tsx, README.md, src/services/predictiveMaintenanceService.ts
- Deleted: None

### Change Log
2025-09-18: Completed mobile optimization implementation. All tasks done, tests pass, ready for QA review.

## QA Results
(To be filled by QA after review)

Status: Ready for Review