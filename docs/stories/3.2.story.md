# Story 3.2: Tenant-Unit Assignment Management

**Status:** Complete

## Acceptance Criteria
- From TenantList or Tenant detail view, allow assigning a tenant to a vacant unit via a modal (Select from available units dropdown or search, filtered by property if context available); on submit, update tenant status to 'active' and unit vacancy to false.
- Support bulk assignment: Checkbox selection in TenantList for multiple tenants, open bulk modal to select multiple units (or vice versa from UnitsList); validate no over-assignment (one tenant per unit).
- Move-out/unassign functionality: From assignment views or unit details, button to unassign tenant, set status to 'evicted' or 'pending', update unit vacancy to true; confirmation dialog required.
- Integration: In PropertyDetail (from Story 2.2), add tenant tab or section showing assigned tenants per unit; in UnitsList, display current tenant info and assign/unassign actions.
- Search/filter: When assigning, filter units by property, status (vacant only), with search by unit number/address.
- Validation: Prevent assigning to occupied units or invalid tenant status; date checks (lease aligns with unit availability); error messages for conflicts.
- Notifications: Snackbar for success (assigned/unassigned) and errors (e.g., unit not vacant).
- Accessibility: ARIA for modals/selects, keyboard-selectable options, screen reader announcements for assignments.
- Responsiveness: Modals adapt to mobile, dropdowns use virtual scrolling if many units.
- Performance: Lazy-load unit options in selects; optimistic UI updates with rollback on failure.

## Dev Notes
No specific guidance found in architecture docs. Infer from backend/prisma/schema.prisma: Tenant model as in 3.1; Unit model with added tenantId (FK to Tenant.id, nullable for vacant). Relations: One-to-one Tenant-Unit. No schema changes assumed; assignments update unit.tenantId and tenant.status/unit.vacancy via API.

API Integration: Extend dashboardService.ts with assignTenantToUnit(tenantId, unitId, leaseDetails), unassignTenant(unitId or tenantId), bulkAssign(tenants, units). Use POST /api/tenants/{tenantId}/assign-unit {unitId, leaseStart, leaseEnd}, PATCH /api/units/{unitId} {tenantId: null, vacancy: true}, POST /api/bulk-assignments. GET /api/units?status=vacant&propertyId={id} for options. Auth and error handling as before.

UI Patterns: Build on UnitForm/BulkUnitForm from 2.2: Use Dialog for assignment modals, Autocomplete or Select for unit selection (with async fetch), MultiSelect for bulk. Integrate into PropertyDetail tabs (add 'Tenants' tab with Table of assignments), update UnitsList to show tenant column and actions. Use existing vacancy logic from 1.2.

Testing: Unit tests for modals (selection, validation, submit), integration for assignment flows (mock APIs, state updates), e2e for full workflow (assign → view in detail → unassign). Cover edge cases: conflicts, bulk errors.

Constraints: Frontend-only; assume backend handles relation integrity. Link to existing routes (e.g., from /properties/{id} to assignments). No impact on prior stories.

## Tasks
- [x] Create AssignmentModal.tsx in src/components/ for single assignment (props: tenantId or unitId, mode: assign/unassign/bulk), with Select/Autocomplete for options, form for lease dates, validation.
- [x] Update TenantList.tsx: Add assign button per row/bulk select, open modal.
- [x] Update UnitsList.tsx (in PropertyDetail): Add tenant column, assign/unassign buttons opening modal.
- [x] Update PropertyDetail.tsx: Add 'Tenants' tab with Table showing unit-tenant pairs, actions.
- [x] Update dashboardService.ts: Add assignment API methods with validation params.
- [x] Implement bulk logic in AssignmentModal (array handling, API call).
- [x] Add confirmation Dialog for unassign.
- [x] Integrate Snackbar and optimistic updates (use React Query mutations).
- [x] Write tests: AssignmentModal.test.tsx (render, selection, submit, bulk), updated component tests for integrations.
- [x] Validate with story-draft-checklist.md and update status to In Progress.

## Dev Agent Record
**Implementation Summary:**
Created AssignmentModal.tsx as a reusable MUI Dialog component with Formik/Yup validation for lease dates, Autocomplete for unit selection (fetched via getVacantUnitOptions), and modes for assign/unassign/bulk. Extended dashboardService.ts with Assignment/UnitOption interfaces and methods (assignTenantToUnit, unassignTenant, bulkAssign, getVacantUnitOptions, getAssignments) using fetch API calls. Updated TenantList.tsx with bulk selection checkboxes, assign buttons, and integrated modal with React Query mutations for optimistic updates and Snackbar notifications. Modified UnitsList.tsx to add tenant column and conditional assign/unassign buttons opening modal. Enhanced PropertyDetail.tsx with new 'Tenants' tab displaying assignments table with unassign actions. Added confirmation Dialog for unassign in modal. All components use TypeScript, MUI for UI, and follow existing patterns for consistency. Tests added: AssignmentModal.test.tsx with comprehensive coverage for all modes, validation, and edge cases; updated TenantList.test.tsx for assignment integrations; created UnitsList.test.tsx and PropertyDetail.test.tsx for full integration testing. All acceptance criteria met with robust test coverage.